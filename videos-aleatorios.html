<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Videos Aleatorios</title>

  <!-- Performance -->
  <link rel="dns-prefetch" href="//api.na-backend.odysee.com">
  <link rel="dns-prefetch" href="//odysee.com">
  <link rel="dns-prefetch" href="//thumbnails.lbry.com">
  <link rel="preconnect" href="https://api.na-backend.odysee.com" crossorigin>
  <link rel="preconnect" href="https://odysee.com" crossorigin>
  <link rel="preconnect" href="https://thumbnails.lbry.com" crossorigin>

  <style>
    /* ===== Tokyo Night ===== */
    :root{
      --tn-bg: #1a1b26;
      --tn-bg2: #16161e;
      --tn-surface: #24283b;
      --tn-surface2:#2a2f45;
      --tn-border: rgba(192,202,245,.14);
      --tn-border2: rgba(122,162,247,.22);

      --tn-fg: #c0caf5;
      --tn-muted: #a9b1d6;
      --tn-muted2: #565f89;

      --tn-blue: #7aa2f7;
      --tn-cyan: #7dcfff;
      --tn-purple: #bb9af7;

      --shadow-lg: 0 30px 120px rgba(0,0,0,.70);
      --shadow-md: 0 18px 60px rgba(0,0,0,.55);
      --blur: blur(12px);

      --radius: 18px;
      --phone-radius: 34px;
    }

    html, body{
      height: 100%;
      margin: 0;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(122,162,247,.12), rgba(26,27,38,0) 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(187,154,247,.10), rgba(26,27,38,0) 55%),
        radial-gradient(900px 700px at 60% 90%, rgba(125,207,255,.08), rgba(26,27,38,0) 55%),
        var(--tn-bg);
      color: var(--tn-fg);
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ -webkit-tap-highlight-color: transparent; }
    ::selection{ background: rgba(51,70,124,.55); }

    .toast{
      position: fixed;
      top: 10px;
      left: 12px;
      right: 12px;
      z-index: 50;
      pointer-events: none;
      display: flex;
      justify-content: center;
    }
    .toast > div{
      max-width: 820px;
      width: fit-content;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(42,47,69,.72), rgba(36,40,59,.48));
      border: 1px solid var(--tn-border2);
      backdrop-filter: var(--blur);
      font-size: 12px;
      color: var(--tn-fg);
      opacity: .96;
      box-shadow: var(--shadow-md);
      letter-spacing: .15px;
    }

    #feed{
      height: 100vh;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      background: transparent;
    }

    @media (min-width: 900px){
      #feed::-webkit-scrollbar{ width: 10px; }
      #feed::-webkit-scrollbar-thumb{
        background: rgba(86,95,137,.45);
        border-radius: 999px;
        border: 2px solid rgba(26,27,38,.75);
      }
      #feed::-webkit-scrollbar-track{ background: rgba(0,0,0,0); }
    }

    .card{
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      isolation: isolate;
      contain: content;
    }

    .bg{
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      transform: scale(1.08);
      opacity: .96;
      filter: saturate(1.05) contrast(1.02) brightness(.70);
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 18%, rgba(122,162,247,.10), rgba(26,27,38,.35) 40%, rgba(26,27,38,.78)),
        linear-gradient(180deg, rgba(26,27,38,.38), rgba(26,27,38,.92));
    }
    @media (min-width: 900px){
      .bg{ filter: blur(18px) saturate(1.05) contrast(1.02) brightness(.64); }
    }

    .stage{
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      z-index: 2;
    }

    /* Full-bleed: mobile full screen, desktop phone frame */
    .frameWrap{
      width: 100vw;
      height: 100vh;
      position: relative;
      background:
        radial-gradient(700px 450px at 30% 20%, rgba(122,162,247,.10), rgba(36,40,59,0) 60%),
        linear-gradient(180deg, rgba(36,40,59,.22), rgba(22,22,30,.30));
    }

    @media (min-width: 840px){
      .frameWrap{
        width: min(520px, 34vw);
        height: calc(100vh - 48px);
        margin: 24px 0;
        border-radius: var(--phone-radius);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(122,162,247,.18);
      }
      .frameWrap::before{
        content:"";
        position:absolute; inset:0;
        pointer-events:none;
        border-radius: var(--phone-radius);
        box-shadow:
          inset 0 1px 0 rgba(192,202,245,.10),
          inset 0 0 0 1px rgba(26,27,38,.55);
        z-index: 8;
      }
      .frameWrap::after{
        content:"";
        position:absolute;
        top: 10px; left: 50%;
        width: 120px; height: 22px;
        transform: translateX(-50%);
        border-radius: 999px;
        background: rgba(22,22,30,.65);
        border: 1px solid rgba(192,202,245,.08);
        z-index: 9;
        pointer-events:none;
      }
    }

    .placeholder{
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      z-index: 4;
      background:
        radial-gradient(900px 700px at 50% 20%, rgba(187,154,247,.08), rgba(36,40,59,.12) 55%, rgba(22,22,30,.26));
    }
    .thumb{
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: .96;
      filter: saturate(1.05) contrast(1.03);
    }
    .thumb::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(26,27,38,.20), rgba(26,27,38,.74));
    }

    iframe{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: #000;
      z-index: 3;
    }

    .play{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      pointer-events: none;
      background: radial-gradient(circle at 30% 25%, rgba(122,162,247,.35), rgba(36,40,59,.55));
      border: 1px solid rgba(125,207,255,.25);
      backdrop-filter: var(--blur);
      box-shadow:
        0 18px 60px rgba(0,0,0,.55),
        0 0 0 6px rgba(122,162,247,.08);
    }
    .play:before{
      content:"▶";
      font-size: 22px;
      margin-left: 3px;
      color: var(--tn-fg);
      text-shadow: 0 2px 14px rgba(0,0,0,.75);
    }

    /* ===== TOP HUD: FIXED stacking ===== */
    .hudTop{
      position: absolute;
      left: 12px;
      right: 80px;
      top: calc(12px + env(safe-area-inset-top));
      z-index: 20;
      pointer-events: none;
      /* IMPORTANT: create local stacking so pseudo-elements can stay behind */
      isolation: isolate;
    }

    /* These MUST be behind the banner (only cover underlying embed title) */
    .hudTop::before{
      content:"";
      position:absolute;
      left: -12px;
      right: -12px;
      top: calc(-12px - env(safe-area-inset-top));
      height: calc(160px + env(safe-area-inset-top));
      background:
        linear-gradient(180deg, rgba(26,27,38,.98) 0%,
                               rgba(26,27,38,.86) 35%,
                               rgba(26,27,38,.52) 70%,
                               rgba(26,27,38,0) 100%);
      pointer-events:none;
      z-index: 0;
    }
    .hudTop::after{
      content:"";
      position:absolute;
      left: -12px;
      right: -12px;
      top: calc(-12px - env(safe-area-inset-top));
      height: calc(68px + env(safe-area-inset-top));
      background: rgba(26,27,38,.98);
      pointer-events:none;
      z-index: 0;
    }

    @media (max-width: 520px){
      .hudTop::before{ height: calc(190px + env(safe-area-inset-top)); }
      .hudTop::after { height: calc(84px + env(safe-area-inset-top)); }
    }

    /* Banner content stays visible */
    .hudCard{
      position: relative;
      z-index: 1; /* <-- key */
      border-radius: 16px;
      padding: 10px 12px;
      max-width: 100%;
      background: linear-gradient(180deg, rgba(42,47,69,.62), rgba(36,40,59,.40));
      border: 1px solid rgba(122,162,247,.22);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow-md);
    }

    .videoTitle{
      font-weight: 900;
      font-size: 13px;
      line-height: 1.18;
      letter-spacing: .18px;
      margin: 0;
      color: var(--tn-fg);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-shadow: 0 2px 16px rgba(0,0,0,.80);
    }

    .meta{
      font-size: 12px;
      color: var(--tn-muted);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }

    .tag{
      display:inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
      background: linear-gradient(180deg, rgba(36,40,59,.65), rgba(22,22,30,.35));
      border: 1px solid rgba(192,202,245,.14);
      color: rgba(192,202,245,.90);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .tag small{ opacity: .95; font-weight: 900; color: var(--tn-cyan); }
    .tag.channel{ border-color: rgba(187,154,247,.22); }

    .actions{
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 21;
      display: grid;
      gap: 6px;
      pointer-events: auto;
      user-select: none;
    }
    .aBtn{
      width: 56px; height: 56px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      cursor: pointer;
      background: radial-gradient(circle at 30% 25%, rgba(122,162,247,.26), rgba(36,40,59,.62));
      border: 1px solid rgba(125,207,255,.22);
      backdrop-filter: var(--blur);
      box-shadow:
        0 18px 60px rgba(0,0,0,.55),
        0 0 0 6px rgba(122,162,247,.06);
      transition: transform 120ms ease, filter 120ms ease;
    }
    .aBtn:hover{ filter: brightness(1.06); }
    .aBtn:active{ transform: translateY(1px) scale(.985); }
    .aBtn span{
      font-size: 20px;
      line-height: 1;
      color: var(--tn-fg);
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
    }
    .aLabel{
      text-align:center;
      font-size: 11px;
      letter-spacing: .12px;
      color: rgba(192,202,245,.85);
      opacity: .92;
      text-shadow: 0 2px 14px rgba(0,0,0,.80);
    }

    .hint{
      position: fixed;
      left: 0; right: 0;
      bottom: 14px;
      display:flex;
      justify-content:center;
      z-index: 25;
      pointer-events: none;
      opacity: .62;
      font-size: 11px;
      letter-spacing: .12px;
      color: rgba(169,177,214,.92);
      text-shadow: 0 2px 14px rgba(0,0,0,.80);
    }

    .skeleton{
      height: 100vh;
      scroll-snap-align: start;
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(122,162,247,.12), rgba(26,27,38,0) 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(187,154,247,.10), rgba(26,27,38,0) 55%),
        linear-gradient(180deg, rgba(36,40,59,.28), rgba(22,22,30,.40));
      display:grid;
      place-items:center;
      color: rgba(192,202,245,.85);
      font-size: 12px;
      letter-spacing: .15px;
    }
  </style>
</head>

<body>
  <div class="toast"><div id="toastMsg"></div></div>

  <main id="feed">
    <section class="skeleton" id="skeleton">Cargando videos…</section>
  </main>

  <div class="hint">Desliza ↑ ↓ · Feed global aleatorio (sin trending)</div>

<script>
(() => {
  const API = "https://api.na-backend.odysee.com/api/v1/proxy";
  const NOT_TAGS = ["porn","nsfw","mature","xxx"];
  // Categorías priorizadas (estilo "feed educativo")
  // Basado en tags/categorías de Odysee: /$/education, /$/lifestyle, /$/tech, /$/finance
  const CATEGORY_TAGS = ["educacion","educación","tech","finance", "ciberseguridad", "desarrollopersonal", "tecnología", "programación", "autocontrol", "autodisciplina", "autosuperacion", "bienestarmental", "calmainterior", "aprenderingles", "fraseseningles", "inglesfacil", "inglesparaprincipiantes", "salud", "ciencia", "física", "química", "biología", "matemáticas", "estadística", "código", "python", "javascript", "electrónica", "robótica", "ingeniería", "astronomía", "contabilidad", "emprendimiento", "economía", "negocios", "idiomas", "gramática", "comunicación", "oratoria", "psicología", "filosofía", "literatura", "arte", "historia", "geografía", "inteligencia-artificial", "aprendizaje-automático", "finanzas-personales", "educación-financiera", "ahorro", "presupuesto", "inversión", "aprender-español", "vocabulario", "pronunciación", "escritura", "historia-del-arte", "tutorial", "guía", "cómo-hacer", "explicación", "productividad", "hábitos", "técnicas-de-estudio", "aprendizaje", "pensamiento-crítico", "resolución-de-problemas", "carrera", "empleo", "entrevista", "currículum", "bricolaje", "reparaciones", "hogar", "cocina", "nutrición", "diseño", "diseño-gráfico", "ux", "flauta", "violín", "piano", "guitarra", "teoría-musical"];

  const PAGE_SIZE = 18;
  const PREFETCH_WHEN_LEFT = 7;
  const DOM_FLUSH_COUNT = 18;

  const PREFETCH_AHEAD = 1;
  const THUMB_PRELOAD_AHEAD = 2;

  let activeCard = null;
  let loading = false;
  let queue = [];
  let seen = new Set();
  let totalPages = 300;

  let pagePool = [];
  let pagePoolCursor = 0;

  const prefetchedEmbeds = new Set();
  const preloadedThumbs = new Set();

  const feed = document.getElementById("feed");
  const toastEl = document.getElementById("toastMsg");
  const skeleton = document.getElementById("skeleton");

  function toast(msg, ms = 1800){
    toastEl.textContent = msg || "";
    if (!msg) return;
    setTimeout(() => { if (toastEl.textContent === msg) toastEl.textContent = ""; }, ms);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function cryptoRandInt(maxExclusive){
    // Unbiased integer in [0, maxExclusive) using CSPRNG (rejection sampling).
    if (!Number.isInteger(maxExclusive) || maxExclusive <= 0) throw new Error("cryptoRandInt: maxExclusive must be a positive integer");
    if (!globalThis.crypto || !crypto.getRandomValues) throw new Error("Secure randomness not available (crypto.getRandomValues missing)");
    if (maxExclusive > 0x100000000) throw new Error("cryptoRandInt: maxExclusive too large");

    const range = 0x100000000; // 2^32
    const limit = range - (range % maxExclusive);
    const u32 = new Uint32Array(1);
    let x;
    do {
      crypto.getRandomValues(u32);
      x = u32[0];
    } while (x >= limit);
    return x % maxExclusive;
  }

  function shuffle(arr){
    // Fisher–Yates shuffle with CSPRNG-backed indices (uniform permutation).
    for (let i = arr.length - 1; i > 0; i--) {
      const j = cryptoRandInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function seedPagePool(){
    const N = Math.max(1, Math.floor(totalPages || 300));
    pagePool = Array.from({ length: N }, (_, i) => i + 1);
    shuffle(pagePool);
    pagePoolCursor = 0;
  }

  function nextRandomPage(){
    if (!pagePool.length) seedPagePool();
    if (pagePoolCursor >= pagePool.length){
      shuffle(pagePool);
      pagePoolCursor = 0;
    }
    return pagePool[pagePoolCursor++];
  }

  function embedUrl(name, claimId){
    return `https://odysee.com/$/embed/${encodeURIComponent(name)}/${claimId}`;
  }
  function openLink(name, claimId){
    return `https://odysee.com/${encodeURIComponent(name)}/${claimId}`;
  }

  // Share URL that opens this same page and loads the shared video by claim_id.
  function shareLink(claimId){
    const base = (location.origin && location.origin !== "null")
      ? `${location.origin}${location.pathname}`
      : location.href.split("?")[0];
    return `${base}?id=${encodeURIComponent(claimId)}`;
  }

  function ensureMeta(attrName, attrValue){
    let meta = document.querySelector(`meta[${attrName}="${attrValue}"]`);
    if (!meta){
      meta = document.createElement("meta");
      meta.setAttribute(attrName, attrValue);
      document.head.appendChild(meta);
    }
    return meta;
  }

  // If the page is opened with ?id=..., set the document title to the video's title
  // so the shared link shows a meaningful tab title (and helps social previews if used).
  function setPageTitleForVideo(videoTitle){
    if (!videoTitle) return;
    document.title = videoTitle;
    ensureMeta("property", "og:title").setAttribute("content", videoTitle);
    ensureMeta("name", "twitter:title").setAttribute("content", videoTitle);
  }


  function prefetchEmbed(url){
    if (!url || prefetchedEmbeds.has(url)) return;
    prefetchedEmbeds.add(url);
    const link = document.createElement("link");
    link.rel = "prefetch";
    link.as = "document";
    link.href = url;
    document.head.appendChild(link);
    setTimeout(() => link.remove(), 6000);
  }

  function preloadThumb(url){
    if (!url || preloadedThumbs.has(url)) return;
    preloadedThumbs.add(url);
    const img = new Image();
    img.decoding = "async";
    img.loading = "eager";
    img.referrerPolicy = "no-referrer";
    img.src = url;
  }

  async function claimSearchByPage(page, count){
    const body = {
      jsonrpc: "2.0",
      id: Date.now(),
      method: "claim_search",
      params: {
        page,
        page_size: count,
        claim_type: "stream",
        stream_types: ["video"],
        not_tags: NOT_TAGS,
        has_source: true,
        any_tags: CATEGORY_TAGS,
        order_by: ["release_time"]
      }
    };

    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    const result = data?.result || {};

    if (typeof result.total_pages === "number" && result.total_pages > 0){
      const changed = (result.total_pages !== totalPages);
      totalPages = result.total_pages;
      if (changed) seedPagePool();
    }
    return (result.items || []);
  }

  async function claimSearchById(claimId){
    const body = {
      jsonrpc: "2.0",
      id: Date.now(),
      method: "claim_search",
      params: {
        claim_ids: [claimId],
        page_size: 1,
        claim_type: "stream",
        stream_types: ["video"],
        not_tags: NOT_TAGS,
        has_source: true,
        no_totals: true
      }
    };

    const res = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    const result = data?.result || {};
    return (result.items || []);
  }

  async function buildBatch(){
    if (loading) return;
    loading = true;
    try{
      const pagesToPull = 3;
      const perPage = Math.max(4, Math.floor(PAGE_SIZE / pagesToPull));
      const pages = Array.from({length: pagesToPull}, () => nextRandomPage());

      let merged = [];
      for (const p of pages){
        const items = await claimSearchByPage(p, perPage);
        merged.push(...items);
      }

      merged = merged.filter(it => it?.claim_id && !seen.has(it.claim_id));
      for (const it of merged) seen.add(it.claim_id);

      shuffle(merged);
      queue.push(...merged);
    } finally {
      loading = false;
    }
  }

  function topTags(it, max = 3){
    const tags = Array.isArray(it?.value?.tags) ? it.value.tags : [];
    return tags.filter(t => typeof t === "string" && t.trim()).slice(0, max);
  }

  function createCard(it){
    const title = it?.value?.title || it?.name || "Video";
    const channel = it?.signing_channel?.name || "";
    const thumbUrl = it?.value?.thumbnail?.url || "";
    const tags = topTags(it, 3);
    const claimId = it.claim_id;

    const section = document.createElement("section");
    section.className = "card";
    section.dataset.claimId = claimId;
    section.dataset.name = it.name;
    section.dataset.thumb = thumbUrl;

    section.innerHTML = `
      <div class="bg" style="background-image:url('${escapeHtml(thumbUrl)}');"></div>

      <div class="stage">
        <div class="frameWrap">
          <div class="placeholder" data-placeholder="1" aria-label="Reproducir">
            <div class="thumb" style="background-image:url('${escapeHtml(thumbUrl)}');"></div>
            <div class="play" title="Reproducir"></div>
          </div>
        </div>
      </div>

      <div class="hudTop">
        <div class="hudCard">
          <div class="videoTitle">${escapeHtml(title)}</div>
          <div class="meta">
            ${tags.map(t => `<span class="tag"><small>#</small>${escapeHtml(t)}</span>`).join("")}
            ${channel ? `<span class="tag channel">${escapeHtml(channel)}</span>` : ""}
          </div>
        </div>
      </div>

      <div class="actions" aria-label="Compartir">
        <div class="aBtn" data-action="share" title="Compartir"><span>⤴</span></div>
        <div class="aLabel">Share</div>
      </div>
    `;

    section.querySelector("[data-placeholder]")?.addEventListener("click", (e) => {
      e.stopPropagation();
      setActive(section);
    });

    section.querySelector(".actions")?.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;
      e.stopPropagation();
      await doShare(section);
    });

    return section;
  }

  async function doShare(card){
    const name = card.dataset.name;
    const claimId = card.dataset.claimId;
    const url = shareLink(claimId);
    const title = card.querySelector(".videoTitle")?.textContent || "Video";
    try{
      if (navigator.share){
        await navigator.share({ title, text: "Mira este video:", url });
        toast("Compartido");
      } else if (navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(url);
        toast("Link copiado");
      } else {
        prompt("Copia el link:", url);
      }
    } catch {}
  }

  function flushQueue(maxToAdd = DOM_FLUSH_COUNT){
    const take = queue.splice(0, maxToAdd);
    if (!take.length) return;

    const frag = document.createDocumentFragment();
    for (const it of take){
      frag.appendChild(createCard(it));
    }
    feed.appendChild(frag);
    skeleton?.remove();

    const cards = Array.from(feed.querySelectorAll(".card"));
    const last = cards[cards.length - 1];
    if (last?.dataset?.thumb) preloadThumb(last.dataset.thumb);
  }

  function loadIframe(card){
    const existing = card.querySelector("iframe");
    if (existing) return;

    const name = card.dataset.name;
    const claimId = card.dataset.claimId;
    if (!name || !claimId) return;

    const wrap = card.querySelector(".frameWrap");
    const placeholder = card.querySelector("[data-placeholder]");
    if (placeholder) placeholder.style.display = "none";

    const iframe = document.createElement("iframe");
    iframe.allow = "autoplay; fullscreen; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.loading = "eager";
    iframe.referrerPolicy = "strict-origin-when-cross-origin";
    iframe.src = embedUrl(name, claimId);
    wrap.appendChild(iframe);
  }

  function unloadIframe(card){
    const iframe = card.querySelector("iframe");
    if (iframe) iframe.remove();
    const placeholder = card.querySelector("[data-placeholder]");
    if (placeholder) placeholder.style.display = "grid";
  }

  function primeAhead(){
    const cards = Array.from(feed.querySelectorAll(".card"));
    const idx = activeCard ? cards.indexOf(activeCard) : -1;
    if (idx < 0) return;

    for (let i = 1; i <= PREFETCH_AHEAD; i++){
      const next = cards[idx + i];
      if (!next) continue;
      const url = `https://odysee.com/$/embed/${encodeURIComponent(next.dataset.name)}/${next.dataset.claimId}`;
      prefetchEmbed(url);
    }
    for (let i = 1; i <= THUMB_PRELOAD_AHEAD; i++){
      const next = cards[idx + i];
      if (!next) continue;
      preloadThumb(next.dataset.thumb);
    }
  }

  function setActive(card){
    if (!card || card === activeCard) return;

    if (activeCard){
      unloadIframe(activeCard);
      activeCard.classList.remove("active");
    }

    activeCard = card;
    activeCard.classList.add("active");
    loadIframe(activeCard);

    primeAhead();
    maybePrefetch();
  }

  const io = new IntersectionObserver((entries) => {
    let best = null;
    for (const e of entries){
      if (!e.isIntersecting) continue;
      if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
    }
    if (best && best.intersectionRatio >= 0.65){
      setActive(best.target);
    }
  }, { root: feed, threshold: [0.35, 0.5, 0.65, 0.8, 0.95] });

  const mo = new MutationObserver((mutations) => {
    for (const m of mutations){
      for (const node of m.addedNodes){
        if (node?.classList?.contains("card")) io.observe(node);
      }
    }
  });
  mo.observe(feed, { childList: true });

  async function queueBuildAndFlush(){
    if (loading) return;
    await buildBatch();
    flushQueue(DOM_FLUSH_COUNT);
  }

  function maybePrefetch(){
    if (!activeCard) return;
    const cards = Array.from(feed.querySelectorAll(".card"));
    const idx = cards.indexOf(activeCard);
    const remaining = (idx >= 0) ? (cards.length - 1 - idx) : cards.length;
    if (remaining <= PREFETCH_WHEN_LEFT) queueBuildAndFlush();
  }

  feed.addEventListener("scroll", () => {
    const nearEnd = feed.scrollTop + feed.clientHeight > feed.scrollHeight - (2 * feed.clientHeight);
    if (nearEnd) queueBuildAndFlush();
  }, { passive: true });

  (async () => {
    try{
      const sharedId = new URLSearchParams(location.search).get("id");
      if (sharedId){
        toast("Cargando video compartido…");
        try{
          const items = await claimSearchById(sharedId);
          const shared = items && items[0];
          if (shared){
            setPageTitleForVideo(shared?.value?.title || shared?.name);
            if (shared.claim_id) seen.add(shared.claim_id);
            feed.appendChild(createCard(shared));
            skeleton?.remove();
          } else {
            toast("No se encontró el video compartido; cargando feed aleatorio…", 2500);
          }
        } catch (err){
          console.warn("No se pudo cargar el video compartido:", err);
          toast("No se pudo cargar el video compartido; cargando feed aleatorio…", 2500);
        }
      }

      toast("Cargando feed aleatorio neutral…");
      seedPagePool();

      await buildBatch();
      flushQueue(24);

      requestAnimationFrame(() => {
        const first = feed.querySelector(".card");
        if (first) setActive(first);
        toast("");
      });

      const idle = window.requestIdleCallback || ((fn) => setTimeout(fn, 250));
      idle(async () => {
        await buildBatch();
        flushQueue(18);
      });
    } catch (e){
      console.error(e);
      toast("Error cargando. Revisa Console/Network.", 4000);
    }
  })();
})();
</script>

</body>
</html>
